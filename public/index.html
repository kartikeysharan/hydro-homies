<!DOCTYPE html>
<html>
<head>
    <title>Hydro Homies Tracker</title>
</head>
<body>
    <h1>Hydro Homies</h1>
    
    <div>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button id="signup">Sign Up</button>
        <button id="login">Login</button>
    </div>
    
    <h2>Welcome, <span id="user-name">Guest</span></h2>
    
    <button id="log-water">Drink 1L</button>
    <p>Today you drank: <span id="total">0</span> L</p>
    <p>Your friend drank: <span id="friend-total">0</span> L</p>
    
    <script type="module">
      // 1️⃣ Import Firebase SDK
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

      // 2️⃣ Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyCfMLAnZKb7cAiEwliEnCtrpwIoKOjr1kg",
        authDomain: "hydro-homies-458f6.firebaseapp.com",
        projectId: "hydro-homies-458f6",
        storageBucket: "hydro-homies-458f6.appspot.com",
        messagingSenderId: "533318428966",
        appId: "1:533318428966:web:3f9ee356e1e3c0b3c939e7",
        measurementId: "G-FX4JNM96X6"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const signupBtn = document.getElementById("signup");
      const loginBtn = document.getElementById("login");
      const logBtn = document.getElementById("log-water");
      const totalEl = document.getElementById("total");
      const friendEl = document.getElementById("friend-total");
      const userNameEl = document.getElementById("user-name");

      let currentUserId = null;
      const friendId = "friend"; // replace with friend's user ID after login

      // --- Sign up ---
      signupBtn.addEventListener("click", async () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        alert("User signed up!");
      });

      // --- Login ---
      loginBtn.addEventListener("click", async () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
      });

      // --- Auth state listener ---
      onAuthStateChanged(auth, (user) => {
        if(user) {
          currentUserId = user.uid;
          userNameEl.textContent = user.email;
          initWaterLogging();
        } else {
          currentUserId = null;
          userNameEl.textContent = "Guest";
        }
      });

      function getToday() {
        return new Date().toISOString().split("T")[0];
      }

      // --- Water logging logic ---
      function initWaterLogging() {
        const todayDoc = doc(db, "logs", getToday());

        // Real-time updates
        onSnapshot(todayDoc, (docSnap) => {
          const data = docSnap.data() || {};
          const userTotal = data[currentUserId]?.reduce((a,b)=>a+b,0) || 0;
          const friendTotal = data[friendId]?.reduce((a,b)=>a+b,0) || 0;
          totalEl.textContent = userTotal;
          friendEl.textContent = friendTotal;
        });

        // Log water button
        logBtn.addEventListener("click", async () => {
          const docSnap = await getDoc(todayDoc);
          if(docSnap.exists()) {
            await updateDoc(todayDoc, { [currentUserId]: arrayUnion(1) });
          } else {
            await setDoc(todayDoc, { [currentUserId]: [1] });
          }
        });
      }

    </script>
</body>
</html>
