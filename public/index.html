<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCfMLAnZKb7cAiEwliEnCtrpwIoKOjr1kg",
  authDomain: "hydro-homies-458f6.firebaseapp.com",
  projectId: "hydro-homies-458f6",
  storageBucket: "hydro-homies-458f6.firebasestorage.app",
  messagingSenderId: "533318428966",
  appId: "1:533318428966:web:3f9ee356e1e3c0b3c939e7",
  measurementId: "G-FX4JNM96X6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const goal = 120;

let yourTotal = 0;
let friendTotal = 0;

// Reference to hydration data
const hydrationRef = ref(db, "hydration");

// Listen to database changes (live sync)
onValue(hydrationRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
        yourTotal = data.yourTotal || 0;
        friendTotal = data.friendTotal || 0;
    } else {
        // Initialize if empty
        yourTotal = 0;
        friendTotal = 0;
        saveData();
    }
    updateUI(false); // false = don't save again to DB
});

// Save totals to Firebase
function saveData() {
    set(hydrationRef, {
        yourTotal: parseFloat(yourTotal.toFixed(1)),
        friendTotal: parseFloat(friendTotal.toFixed(1)),
        lastUpdated: serverTimestamp()
    });
}

// Update UI with progress bars and winner
function updateUI(shouldSave = true) {
    document.getElementById("your-total").innerText = yourTotal.toFixed(1);
    document.getElementById("friend-total").innerText = friendTotal.toFixed(1);

    let yourPercent = Math.min((yourTotal / goal) * 100, 100);
    let friendPercent = Math.min((friendTotal / goal) * 100, 100);

    const yourBar = document.getElementById("your-progress");
    const friendBar = document.getElementById("friend-progress");

    yourBar.style.width = yourPercent + "%";
    friendBar.style.width = friendPercent + "%";

    document.getElementById("your-percent").innerText = yourPercent.toFixed(0);
    document.getElementById("friend-percent").innerText = friendPercent.toFixed(0);

    updateWinner();

    // Splash animation when totals change
    yourBar.classList.add("splash");
    friendBar.classList.add("splash");
    setTimeout(() => {
        yourBar.classList.remove("splash");
        friendBar.classList.remove("splash");
    }, 600);

    if (shouldSave) saveData();
}

// Add preset amount of water
window.addWater = function(person, amount) {
    if (person === "you") yourTotal += amount;
    else friendTotal += amount;
    updateUI(true);
};

// Add custom amount of water
window.addCustom = function(person) {
    const inputId = person === "you" ? "your-input" : "friend-input";
    let val = parseFloat(document.getElementById(inputId).value);
    if (!isNaN(val) && val > 0) {
        if (person === "you") yourTotal += val;
        else friendTotal += val;
        document.getElementById(inputId).value = "";
        updateUI(true);
    }
};

// Update winner text
function updateWinner() {
    let text = "";
    if (yourTotal > friendTotal) text = "ğŸ† You're winning!";
    else if (friendTotal > yourTotal) text = "ğŸ† Your friend is winning!";
    else text = "It's tied! Stay hydrated ğŸ˜¤ğŸ’§";
    document.getElementById("winner").innerText = text;
}

// Reset totals
window.resetDay = function() {
    yourTotal = 0;
    friendTotal = 0;
    updateUI(true);
};
</script>
